!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).atom={})}(this,function(e){"use strict";const t="await",s="clear",n="value",i="decay";function r(e,t,...s){e.stateListeners&&e.stateListeners.has(t)&&e.stateListeners.get(t).forEach(e=>e.apply(e,s))}function a(e,t,s){if(e.stateListeners||(e.stateListeners=new Map),e.stateListeners.has(t))e.stateListeners.get(t).add(s);else{const n=new Set;n.add(s),e.stateListeners.set(t,n)}}function o(e,t,s){if(e.stateListeners&&e.stateListeners.has(t)){const n=e.stateListeners.get(t);n.has(s)&&n.delete(s)}}function u(e,t){e.stateListeners&&e.stateListeners.forEach(e=>{e.has(t)&&e.delete(t)})}const c=e=>null!=e,l=e=>!!e,h=e=>t=>c(t)?null:e(t),d=e=>t=>c(t)?e(t):null,f=e=>t=>l(t)?e(t):null,p=e=>t=>c(t)&&!l(t)?e(t):null,y=e=>t=>l(t)?null:e(t),g=e=>t=>(s,n)=>{t(s,(t=>()=>t.down(e))(n))},m=e=>{Object.keys(e).forEach(t=>{e[t]&&(e[t]=null),delete e[t]})};function v(e){return!!e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof e.then}function w(e,t){return t&&t.then?b(e,t):(t=>{if(e.wrapperFn){const s=e.wrapperFn(t,e.value);if(s&&s.then)return b(e,s);t=s}if(!e.isFinite||e.value!=t)return e.prev=e.value,e.value=t,_(e),e.isStateless&&delete e.value,delete e.prev,t})(t)}async function b(e,s){r(e,t,!0),e.isAwaiting=s,e.isAsync=!0;const n=await s;if(!e.isFinite||e.value!=n)return e.prev=e.value,e.value=n,e.isAwaiting=!1,r(e,t,!1),_(e),e.isStateless&&delete e.value,delete e.prev,n}function _(e){const t=e.value,s=e.isHoly?e=>e(...t):s=>2==s.length?s(t,e._):s(t);e.listeners.size>0&&e.listeners.forEach(s),e.grandListeners&&e.grandListeners.size>0&&e.grandListeners.forEach(s)}function S(e,t,s){e.grandListeners||(e.grandListeners=new Map);const n=s(t.bind(e._));e.grandListeners.set(t,n),!e._.isEmpty&&n(e.value)}const L=(...e)=>{const t=function(...e){if(e.length){const s=t.isHoly?e:e[0];return w(t,s)}return t.isStateless?void _(t):t.isAwaiting?t.isAwaiting:t.getterFn?w(t,t.getterFn()):t.value};return t.listeners=new Set,t.uid=1e15*(Math.ceil(9*Math.random())+Math.random()),e.length&&t(...e),t};const E="value",O={isEmpty(){return!this.hasOwnProperty(E)},isFilled(){return this.hasOwnProperty(E)},haveListeners(){return this.listeners.size>0},[Symbol.toPrimitive](){return this._.toString()}},k=(e,t)=>!!e.hasOwnProperty(E)&&(e.isHoly?t.call(t,...e.value):t(e.value,e),!0),x={up(e){return this.listeners.add(e),k(this._,e),this._},down(e){return this.listeners.has(e)?this.listeners.delete(e):this.grandListeners&&this.grandListeners.has(e)&&this.grandListeners.delete(e),this._},silent(e){return this.value=e,this._},curry(){const e=this;return function(t){w(e,t)}},decay(e){!e&&r(this,s,i),this.listeners.clear(),this.grandListeners&&this.grandListeners.clear(),this.stateListeners&&this.stateListeners.clear(),this.haveFrom&&delete this.haveFrom,delete this.value,this.risen&&this.risen.forEach(e=>e()),m(this)},clearValue(){return r(this,s,n),delete this.value,this._},resend(){return _(this),this._},mutate(e){return this.value=e(this.value),_(this),this._},next(e){return this.listeners.add(e),this._},once(e){if(!k(this._,e)){const t=s=>{this.listeners.delete(t),e(s)};this.listeners.add(t)}return this._},is(e){return this._.isEmpty?void 0===e:this.value===e},parentFor(e,t){let s=e.getMeta("parents");s||(s={},e.addMeta("parents",s));const n=1|t,i=s[n];i&&i.down(e),s[n]=this._,this._.up(e)},onClear(e){a(this,s,e)},offClear(e){o(this,s,e)},onAwait(e){a(this,t,e)},offAwait(e){o(this,t,e)},upDown(e){return S(this,e,g(e)),this._},upSome(e){return S(this,e,d),this._},upTrue(e){return S(this,e,f),this._},upFalse(e){return S(this,e,y),this._},upSomeFalse(e){return S(this,e,p),this._},upNone(e){return S(this,e,h),this._},setId(e){return this.id=e,this._},setName(e){return this._name=e,Object.defineProperty(this,"name",{value:e}),this._},finite(e){return this.isFinite=null==e||e,this._},holistic(e){return this.isHoly=null==e||e,this._},stateless(e){return this.isStateless=null==e||e,this.isStateless&&this._.clearValue(),this._},bind(e){this._context!=e&&(this._context=e,this.bind(e))},apply(e,t){this.bind(e),w(this,t[0])},call(e,...t){this._(...t)},addMeta(e,t){return this.metaMap||(this.metaMap=new Map),this.metaMap.set(e,t||null),this._},deleteMeta(e){return!!this.metaMap&&this.metaMap.delete(e)},hasMeta(e){return!!this.metaMap&&this.metaMap.has(e)},getMeta(e){return this.metaMap?this.metaMap.get(e):null},dispatch(e,...t){return r(this,e,...t),this._},on(e,t){return a(this,e,t),this._},off(e,t){return o(this,e,t),this._},setGetter(e,t){return this.getterFn=e,this.isAsync=t,this._},setOnceGet(e,t){return this.getterFn=()=>(delete this.getterFn,delete this.isAsync,e()),this.isAsync=t,this._},setWrapper(e,t){return this.wrapperFn=e,this.isAsync=t,this._},tuneTo(e){this.tuneOff(),this.tunedTarget=e,e.up(this._)},tuneOff(){this.tunedTarget&&this.tunedTarget.down(this.tunedTarget)},injectTo(e,t){if(t||(t=this._name?this._name:this.id?this.id:this.uid),!e)throw"trying inject quark to null object";return e[t]=this.value,this._},cloneValue(){return JSON.parse(JSON.stringify(this.value))},[Symbol.toPrimitive](){this._.toString()},[Symbol.dispose](){this._.decay()},toString(){return`nucleon:${this._.uid}`},valueOf(){return`nucleon:${this._.uid}`},from:function(...e){const t=this;if(t.parents)throw"from nucleons already has a assigned";t.parents=e;const s=[],n=()=>new Promise(e=>s.push(e)),i=e=>{for(;s.length;)s.pop()(e);t.isAwaiting&&delete t.isAwaiting},r=s=>{const r=[],{strong:a,some:o}=s,u=a||o,l=e.map(e=>((e.isAwaiting||u&&!c(e.value))&&r.push(e),e.value));return r.length>0?(t.getterFn=n,t.isAwaiting=n()):(t.getterFn=()=>s(...l),v(h=s(...l))?h.then(e=>{i(e),w(t,e)}):(i(h),w(t,h)),t.isAwaiting&&delete t.isAwaiting,h);var h},a={},o=(e,s)=>{e.next(s),t.decayHooks||(t.decayHooks=[]),t.decayHooks.push(()=>e.down(s))};function u(s,n){function i(e,t){e!==a[t.uid]&&(r(s),a[t.uid]=e)}return e.forEach(e=>{e!==t._&&(a[e.uid]=e.value,o(e,i))}),r(s),t._}function l(s,r){let u={},c=!1;function l(r){const o={},h=()=>Object.keys(o).length,d=e.map(e=>{let t=u[e.uid];if(t)return t;const s=a[e.uid];return t=r&&r==e.uid?s||e():e.isStateless?e():s||e(),v(t)&&(o[e.uid]=!0,t.then(t=>{if(u[e.uid]=t,a[e.uid]=t,delete o[e.uid],!h()){const e=l();v(e)||i(e)}})),a[e.uid]=t,t});if(h())return t.getterFn=n,t.isAwaiting=n();t.getterFn=l,u={};const f=s(...d);return c||(c=!0,t(f)),f}t._.finite(r);const h={};function d(s,n){if(s!==a[n.uid]){if(a[n.uid]=s,!function(){let t=!1;const s=Object.keys(a);return s.forEach(e=>{a[e]!==h[e]&&(t=!0),h[e]=a[e]}),t&&e.length==s.length}())return;if(c){const e=l(n.uid);v(e)?e.then(t):t(e)}}}return e.forEach(e=>{e.uid!==t._.uid&&o(e,d)}),t.getterFn=()=>l(),l(),t._}return{some:function(e){return e.some=!0,u(e)},weak:e=>u(e),strong:e=>l(e,!0)}}},M={extensions:{}},j={get(e,t){const s=e[t];if(s||void 0!==s||null!=s)return s;let n=M.extensions[t]||O[t];return n?n.apply(e):(n=x[t],n?(...t)=>n.call(e,...t):s)}};function A(e){const t=L(...arguments);return t._=new Proxy(t,j),t._}function F(e,t){e.everythingListeners?.has(t)&&e.everythingListeners.delete(t)}function N(e,t){e.everythingListeners||(e.everythingListeners=new Set),e.everythingListeners.add(t)}const P={decay(e){const t=e=>{e&&e.forEach(e.delete)};t(e.buses),t(e.everythingListeners),e.stateListeners&&e.stateListeners.forEach((t,s)=>e.stateListeners.delete(s))},addEverythingListener:N,addEventListener:(e,t,s)=>a(e,t,s),removeEventListener:(e,t,s)=>{o(e,t,s)},removeListener:(e,t)=>{u(e,t),F(e,t)},dispatchEvent:(e,t,s)=>{e.everythingListeners&&e.everythingListeners.forEach(e=>e(t,s)),r(e,t,s)},getListenersMap:e=>(e.stateListeners||(e.stateListeners=new Map),e.stateListeners),addEventToBus(e,t,s){const n=e=>s.dispatchEvent(t,e);return a(e,t,n),n},removeEventToBus(e,t){u(e,t)},addBus(e,t){e.buses||(e.buses=new Set),e.buses.has(t)||(e.buses.add(t),N(e,t.dispatchEvent))},removeBus(e,t){e.buses?.has(t)&&(e.buses.delete(t),F(e,t.dispatchEvent))}},V={get(e,t){const s=P[t];return s?(...t)=>s(e,...t):(console.error(t,"404",e),e[t])}};const T=Object.assign(A,{setOnceGet:e=>A().setOnceGet(e),setGetter:e=>A().setGetter(e),setWrapper:e=>A().setWrapper(e),from:(...e)=>A().from(...e),stateless:()=>A().stateless(),holistic:()=>A().holistic(),id(e,t){const s=A().setId(e);return c(t)&&s(t),s}});function I(e,t){const s={};return Object.keys(e.getters).forEach(n=>{const i=T.id(t+"."+n),r=e.getters[n],a=()=>{const t=r.apply(e.state);i(t)};i.addMeta("sleep",()=>function(e,t,s,n,i){const r={},a=new Proxy(s,{get:(e,s)=>(t(s),"string"==typeof s&&(r[s]=!0),e[s])});e(n.apply(a)),Object.keys(r).forEach(e=>{t(e).next(i)})}(i,e.getNucleon,e.state,r,a)),s[n]=i}),s}globalThis.Nucleus=T;const H=!![typeof window,typeof document].includes("undefined"),B={init(e){H?function(e){const t=require("fs"),s=require("path");C.isReady||(C.dir=s.resolve(C.dir),t.existsSync(C.dir)||t.mkdirSync(C.dir),C.isReady=!0);const n=s.join(C.dir,e.id+".json");let i,r;const a=s=>{!i||Date.now()-i>300?(i=Date.now(),t.writeFile(n,JSON.stringify(s),()=>{})):r||(r=setTimeout(()=>{i=Date.now(),r=null,t.writeFile(n,JSON.stringify(e.value),()=>{})},300))};if(t.existsSync(n)){const s=t.readFileSync(n),i=JSON.parse(s);e(i),e.next(a)}else e.up(a)}(e):function(e){let t=localStorage.getItem(e.id);const s=t=>localStorage.setItem(e.id,JSON.stringify(t));if(t&&"undefined"!=t){let n=JSON.parse(t);e(n),e.next(s)}else e.up(s);e.onClear(()=>{localStorage.removeItem(e.id)})}(e)}},C={dir:"./.nuclearStore",isReady:!1};const G=Symbol.for("saved"),J=Symbol.for("finite"),q=Symbol.for("tag"),D=Symbol.for("stateless"),W=Symbol.for("mixed"),U=Symbol.for("wrapped");const $=new Proxy(function(...e){const[t]=e;return{sym:q,startValue:t,tag:!0}},{get:(e,t)=>e=>({sym:q,startValue:e,tag:t})});const z=e=>null!=e,K=["constructor"];const R=e=>"string"==typeof e,Q=(e,t)=>new Proxy({valence:e,core:t},{get:(s,n)=>s.core.nucleons[n]||function(e,t,s){let n=s.nucleons[e];if(!n&&!K.includes(e)&&"string"==typeof e){const i=s.name?`${s.name}.${e}`:e;let r,a;if(a=s.saved,s.nucleons[e]=n=T(),t){let s=t[e];if(delete t[e],z(s)){const e=e=>{switch(e?.sym){case q:n.addMeta("tag",e.tag);break;case G:a=!0;break;case D:n.stateless();break;case J:n.finite();break;case U:n.setWrapper(e.wrapper)}z(e.startValue)&&(r=e.startValue)};switch(!0){case s.mix?.length>1:s.mix.forEach(t=>{switch(!0){case"function"==typeof t:e(t());break;case"symbol"==typeof t.sym:e(t);break;default:r=t}});break;case"symbol"==typeof s.sym:e(s);break;default:r=s}}}switch(s.nucleusStrategy){case"finite":n.finite();break;case"holistic":n.holistic();break;case"stateless":n.stateless();break;case"holystate":n.holistic(),n.stateless()}if(n.setId(i),a?(B.init(n),n.isEmpty&&z(r)&&n(r)):z(r)&&n(r),s.metaMap){const t=s.metaMap[e];t?.forEach(n.addMeta)}n.hasMeta("no_bus")||(s.emitChanges&&n.up(t=>{s.quarkBus.dispatchEvent("NUCLEUS_CHANGE",{key:e,value:t,atomId:s.name,n:n})}),s.quarkBus.dispatchEvent("NUCLEUS_INIT",n))}return n}(n,e,t)}),X=(e,t)=>new Proxy({getter:e,core:t},{get(e,t){const s=e.getter(t);return s?s.value:e.core[t]},set:(e,t,s)=>(e.core[t]=s,!0)}),Y=(e,t)=>new Proxy({shell:e,core:t},{get(e,t){const s=e.shell[t];return null!=s?s:e.core[t]},set:(e,t,s)=>(e.core[t]=s,!0)}),Z=e=>new Proxy({atom:e},{get(e,t){if(R(t))return e.atom[t].value},set:(e,t,s)=>!!R(t)&&(e.atom[t](s),!0)});class ee{getNucleon;getters={};actions={};instaValues={};savedKeys=[];core;state;constructor(e,t){this.getNucleon=e,this.core=new Proxy({},{get(s,n,i){let r=t.nucleons[n];return r||(r=t.actions[n],r||e(n))}})}addEternals(e){this.savedKeys.push(...e)}}function te(e){const t={nucleons:{},actions:{},sleepingNucleons:{},superEternal:!1},s={values(){const e={};return s.keys?.forEach(t=>{e[t]=i.state[t]}),e}},n=new Set,i=new ee(function(e){let s=t.sleepingNucleons[e];if(s){s.getMeta("sleep")(),s.deleteMeta("sleep"),t.nucleons[e]=s,delete t.sleepingNucleons[e]}else s=t.nucleons[e]||c.atom[e];n||(n[e]=!0);return s},t);"saved"===e.nucleusStrategy||"*"===e.saved?t.superEternal=!0:"string"!=typeof e.saved&&e.saved&&"string"==typeof e.saved[0]&&(i.savedKeys=e.saved);const r=(t,n)=>{const r=function(e,t){const s={},n={},i={};if("function"==typeof e){const r=new e(t.constructorArgs),a=e=>{const t=Object.getOwnPropertyNames(e);if(-1===t.indexOf("__proto__")){t.forEach(t=>{if("constructor"===t)return;const i=Object.getOwnPropertyDescriptor(e,t);i.get?s[t]=i.get:n[t]=r[t]});const i=Object.getPrototypeOf(e);i&&a(i)}};a(e.prototype),Object.keys(r).forEach(e=>{i[e]=r[e]})}else Object.keys(e).forEach(t=>{const s=e[t];"function"==typeof s?n[t]=s:i[t]=s});return{getters:s,actions:n,saveds:[],instaValues:i}}(t,e);Object.assign(i.actions,r.actions),Object.assign(i.getters,r.getters),Object.assign(i.instaValues,r.instaValues),i.addEternals(r.saveds);const a=e=>!e.startsWith("_");s.actions=new Set(Object.keys(i.actions).filter(a));const o=Object.keys(r.instaValues);o.push(...Object.keys(r.getters)),s.keys=new Set(o.filter(a)),n&&i.addEternals(o)};e.model&&r(e.model),e.saved&&r(e.saved,!0);const a=!!e.bus,o=e.bus||new Proxy({id:u},V);var u;const c=function(e,t,s,n){const i=Q(e.instaValues,Object.assign({nucleons:{},quarkBus:n},s)),r=I(e,s.name);Object.assign(t.sleepingNucleons,r);const a=Z(i),o=X(e.getNucleon,a),u=Y(t.actions,o),c=s.thisExtension?Y(s.thisExtension,u):u;return e.state=c,Object.keys(e.actions).forEach(s=>{t.actions[s]=(...t)=>e.actions[s].apply(c,t)}),{atom:i}}(i,t,e,o);const l={core:i.core,state:i.state,actions:t.actions,decay:function(){Object.keys(n).forEach(e=>{let s=t.sleepingNucleons[e]||t.nucleons[e]||c.atom[e];s&&s.decay()}),a&&o.decay();m(l),m(c),m(s)},bus:o,known:s};return l}const se=te,ne=te;e.A=ne,e.Atom=se,e.MultiAtomic=class{id},e.coreAtom=e=>new Proxy(se({model:e}),{get:(e,t)=>e.core[t]}),e.finite=function(e){return{sym:J,startValue:e}},e.finiteSym=J,e.mixed=function(...e){return{sym:W,mix:e}},e.mixedSym=W,e.saved=function(e){return{sym:G,startValue:e}},e.savedAtom=(e,t)=>se({model:t,name:e,saved:!0}),e.savedSym=G,e.stateless=function(e){return{sym:D,startValue:e}},e.statelessSym=D,e.storage=B,e.tag=$,e.tagSym=q,e.wrap=function(e,t){return{sym:U,startValue:t,wrapper:e}},e.wrapSym=U});
