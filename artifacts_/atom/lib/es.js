const e="await",t="clear",s="value",n="decay";function i(e,t,...s){e.stateListeners&&e.stateListeners.has(t)&&e.stateListeners.get(t).forEach(e=>e.apply(e,s))}function r(e,t,s){if(e.stateListeners||(e.stateListeners=new Map),e.stateListeners.has(t))e.stateListeners.get(t).add(s);else{const n=new Set;n.add(s),e.stateListeners.set(t,n)}}function a(e,t,s){if(e.stateListeners&&e.stateListeners.has(t)){const n=e.stateListeners.get(t);n.has(s)&&n.delete(s)}}function o(e,t){e.stateListeners&&e.stateListeners.forEach(e=>{e.has(t)&&e.delete(t)})}const u=e=>null!=e,c=e=>!!e,l=e=>t=>u(t)?null:e(t),h=e=>t=>u(t)?e(t):null,d=e=>t=>c(t)?e(t):null,f=e=>t=>u(t)&&!c(t)?e(t):null,g=e=>t=>c(t)?null:e(t),p=e=>t=>(s,n)=>{t(s,(t=>()=>t.down(e))(n))},y=e=>{Object.keys(e).forEach(t=>{e[t]&&(e[t]=null),delete e[t]})};function m(e){return!!e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof e.then}function v(e,t){return t&&t.then?w(e,t):(t=>{if(e.wrapperFn){const s=e.wrapperFn(t,e.value);if(s&&s.then)return w(e,s);t=s}if(!e.isFinite||e.value!=t)return e.prev=e.value,e.value=t,_(e),e.isStateless&&delete e.value,delete e.prev,t})(t)}async function w(t,s){i(t,e,!0),t.isAwaiting=s,t.isAsync=!0;const n=await s;if(!t.isFinite||t.value!=n)return t.prev=t.value,t.value=n,t.isAwaiting=!1,i(t,e,!1),_(t),t.isStateless&&delete t.value,delete t.prev,n}function _(e){const t=e.value,s=e.isHoly?e=>e(...t):s=>2==s.length?s(t,e._):s(t);e.listeners.size>0&&e.listeners.forEach(s),e.grandListeners&&e.grandListeners.size>0&&e.grandListeners.forEach(s)}function b(e,t,s){e.grandListeners||(e.grandListeners=new Map);const n=s(t.bind(e._));e.grandListeners.set(t,n),!e._.isEmpty&&n(e.value)}const L=(...e)=>{const t=function(...e){if(e.length){const s=t.isHoly?e:e[0];return v(t,s)}return t.isStateless?void _(t):t.isAwaiting?t.isAwaiting:t.getterFn?v(t,t.getterFn()):t.value};return t.listeners=new Set,t.uid=1e15*(Math.ceil(9*Math.random())+Math.random()),e.length&&t(...e),t};const E="value",S={isEmpty(){return!this.hasOwnProperty(E)},isFilled(){return this.hasOwnProperty(E)},haveListeners(){return this.listeners.size>0},[Symbol.toPrimitive](){return this._.toString()}},O=(e,t)=>!!e.hasOwnProperty(E)&&(e.isHoly?t.call(t,...e.value):t(e.value,e),!0),k={up(e){return this.listeners.add(e),O(this._,e),this._},down(e){return this.listeners.has(e)?this.listeners.delete(e):this.grandListeners&&this.grandListeners.has(e)&&this.grandListeners.delete(e),this._},silent(e){return this.value=e,this._},curry(){const e=this;return function(t){v(e,t)}},decay(e){!e&&i(this,t,n),this.listeners.clear(),this.grandListeners&&this.grandListeners.clear(),this.stateListeners&&this.stateListeners.clear(),this.haveFrom&&delete this.haveFrom,delete this.value,this.risen&&this.risen.forEach(e=>e()),y(this)},clearValue(){return i(this,t,s),delete this.value,this._},resend(){return _(this),this._},mutate(e){return this.value=e(this.value),_(this),this._},next(e){return this.listeners.add(e),this._},once(e){if(!O(this._,e)){const t=s=>{this.listeners.delete(t),e(s)};this.listeners.add(t)}return this._},is(e){return this._.isEmpty?void 0===e:this.value===e},parentFor(e,t){let s=e.getMeta("parents");s||(s={},e.addMeta("parents",s));const n=1|t,i=s[n];i&&i.down(e),s[n]=this._,this._.up(e)},onClear(e){r(this,t,e)},offClear(e){a(this,t,e)},onAwait(t){r(this,e,t)},offAwait(t){a(this,e,t)},upDown(e){return b(this,e,p(e)),this._},upSome(e){return b(this,e,h),this._},upTrue(e){return b(this,e,d),this._},upFalse(e){return b(this,e,g),this._},upSomeFalse(e){return b(this,e,f),this._},upNone(e){return b(this,e,l),this._},setId(e){return this.id=e,this._},setName(e){return this._name=e,Object.defineProperty(this,"name",{value:e}),this._},finite(e){return this.isFinite=null==e||e,this._},holistic(e){return this.isHoly=null==e||e,this._},stateless(e){return this.isStateless=null==e||e,this.isStateless&&this._.clearValue(),this._},bind(e){this._context!=e&&(this._context=e,this.bind(e))},apply(e,t){this.bind(e),v(this,t[0])},call(e,...t){this._(...t)},addMeta(e,t){return this.metaMap||(this.metaMap=new Map),this.metaMap.set(e,t||null),this._},deleteMeta(e){return!!this.metaMap&&this.metaMap.delete(e)},hasMeta(e){return!!this.metaMap&&this.metaMap.has(e)},getMeta(e){return this.metaMap?this.metaMap.get(e):null},dispatch(e,...t){return i(this,e,...t),this._},on(e,t){return r(this,e,t),this._},off(e,t){return a(this,e,t),this._},setGetter(e,t){return this.getterFn=e,this.isAsync=t,this._},setOnceGet(e,t){return this.getterFn=()=>(delete this.getterFn,delete this.isAsync,e()),this.isAsync=t,this._},setWrapper(e,t){return this.wrapperFn=e,this.isAsync=t,this._},tuneTo(e){this.tuneOff(),this.tunedTarget=e,e.up(this._)},tuneOff(){this.tunedTarget&&this.tunedTarget.down(this.tunedTarget)},injectTo(e,t){if(t||(t=this._name?this._name:this.id?this.id:this.uid),!e)throw"trying inject quark to null object";return e[t]=this.value,this._},cloneValue(){return JSON.parse(JSON.stringify(this.value))},[Symbol.toPrimitive](){this._.toString()},[Symbol.dispose](){this._.decay()},toString(){return`nucleon:${this._.uid}`},valueOf(){return`nucleon:${this._.uid}`},from:function(...e){const t=this;if(t.parents)throw"from nucleons already has a assigned";t.parents=e;const s=[],n=()=>new Promise(e=>s.push(e)),i=e=>{for(;s.length;)s.pop()(e);t.isAwaiting&&delete t.isAwaiting},r=s=>{const r=[],{strong:a,some:o}=s,c=a||o,l=e.map(e=>((e.isAwaiting||c&&!u(e.value))&&r.push(e),e.value));return r.length>0?(t.getterFn=n,t.isAwaiting=n()):(t.getterFn=()=>s(...l),m(h=s(...l))?h.then(e=>{i(e),v(t,e)}):(i(h),v(t,h)),t.isAwaiting&&delete t.isAwaiting,h);var h},a={},o=(e,s)=>{e.next(s),t.decayHooks||(t.decayHooks=[]),t.decayHooks.push(()=>e.down(s))};function c(s,n){function i(e,t){e!==a[t.uid]&&(r(s),a[t.uid]=e)}return e.forEach(e=>{e!==t._&&(a[e.uid]=e.value,o(e,i))}),r(s),t._}function l(s,r){let u={},c=!1;function l(r){const o={},h=()=>Object.keys(o).length,d=e.map(e=>{let t=u[e.uid];if(t)return t;const s=a[e.uid];return t=r&&r==e.uid?s||e():e.isStateless?e():s||e(),m(t)&&(o[e.uid]=!0,t.then(t=>{if(u[e.uid]=t,a[e.uid]=t,delete o[e.uid],!h()){const e=l();m(e)||i(e)}})),a[e.uid]=t,t});if(h())return t.getterFn=n,t.isAwaiting=n();t.getterFn=l,u={};const f=s(...d);return c||(c=!0,t(f)),f}t._.finite(r);const h={};function d(s,n){if(s!==a[n.uid]){if(a[n.uid]=s,!function(){let t=!1;const s=Object.keys(a);return s.forEach(e=>{a[e]!==h[e]&&(t=!0),h[e]=a[e]}),t&&e.length==s.length}())return;if(c){const e=l(n.uid);m(e)?e.then(t):t(e)}}}return e.forEach(e=>{e.uid!==t._.uid&&o(e,d)}),t.getterFn=()=>l(),l(),t._}return{some:function(e){return e.some=!0,c(e)},weak:e=>c(e),strong:e=>l(e,!0)}}},M={extensions:{}},x={get(e,t){const s=e[t];if(s||void 0!==s||null!=s)return s;let n=M.extensions[t]||S[t];return n?n.apply(e):(n=k[t],n?(...t)=>n.call(e,...t):s)}};function j(e){const t=L(...arguments);return t._=new Proxy(t,x),t._}function F(e,t){e.everythingListeners?.has(t)&&e.everythingListeners.delete(t)}function N(e,t){e.everythingListeners||(e.everythingListeners=new Set),e.everythingListeners.add(t)}const A={decay(e){const t=e=>{e&&e.forEach(e.delete)};t(e.buses),t(e.everythingListeners),e.stateListeners&&e.stateListeners.forEach((t,s)=>e.stateListeners.delete(s))},addEverythingListener:N,addEventListener:(e,t,s)=>r(e,t,s),removeEventListener:(e,t,s)=>{a(e,t,s)},removeListener:(e,t)=>{o(e,t),F(e,t)},dispatchEvent:(e,t,s)=>{e.everythingListeners&&e.everythingListeners.forEach(e=>e(t,s)),i(e,t,s)},getListenersMap:e=>(e.stateListeners||(e.stateListeners=new Map),e.stateListeners),addEventToBus(e,t,s){const n=e=>s.dispatchEvent(t,e);return r(e,t,n),n},removeEventToBus(e,t){o(e,t)},addBus(e,t){e.buses||(e.buses=new Set),e.buses.has(t)||(e.buses.add(t),N(e,t.dispatchEvent))},removeBus(e,t){e.buses?.has(t)&&(e.buses.delete(t),F(e,t.dispatchEvent))}},P={get(e,t){const s=A[t];return s?(...t)=>s(e,...t):(console.error(t,"404",e),e[t])}};const V=Object.assign(j,{setOnceGet:e=>j().setOnceGet(e),setGetter:e=>j().setGetter(e),setWrapper:e=>j().setWrapper(e),from:(...e)=>j().from(...e),stateless:()=>j().stateless(),holistic:()=>j().holistic(),id(e,t){const s=j().setId(e);return u(t)&&s(t),s}});function T(e,t){const s={};return Object.keys(e.getters).forEach(n=>{const i=V.id(t+"."+n),r=e.getters[n],a=()=>{const t=r.apply(e.state);i(t)};i.addMeta("sleep",()=>function(e,t,s,n,i){const r={},a=new Proxy(s,{get:(e,s)=>(t(s),"string"==typeof s&&(r[s]=!0),e[s])});e(n.apply(a)),Object.keys(r).forEach(e=>{t(e).next(i)})}(i,e.getNucleon,e.state,r,a)),s[n]=i}),s}globalThis.Nucleus=V;const I=!![typeof window,typeof document].includes("undefined"),H={init(e){I?function(e){const t=require("fs"),s=require("path");B.isReady||(B.dir=s.resolve(B.dir),t.existsSync(B.dir)||t.mkdirSync(B.dir),B.isReady=!0);const n=s.join(B.dir,e.id+".json");let i,r;const a=s=>{!i||Date.now()-i>300?(i=Date.now(),t.writeFile(n,JSON.stringify(s),()=>{})):r||(r=setTimeout(()=>{i=Date.now(),r=null,t.writeFile(n,JSON.stringify(e.value),()=>{})},300))};if(t.existsSync(n)){const s=t.readFileSync(n),i=JSON.parse(s);e(i),e.next(a)}else e.up(a)}(e):function(e){let t=localStorage.getItem(e.id);const s=t=>localStorage.setItem(e.id,JSON.stringify(t));if(t&&"undefined"!=t){let n=JSON.parse(t);e(n),e.next(s)}else e.up(s);e.onClear(()=>{localStorage.removeItem(e.id)})}(e)}},B={dir:"./.nuclearStore",isReady:!1};const C=Symbol.for("saved"),G=Symbol.for("finite"),J=Symbol.for("tag"),q=Symbol.for("stateless"),D=Symbol.for("mixed"),W=Symbol.for("wrapped");const U=new Proxy(function(...e){const[t]=e;return{sym:J,startValue:t,tag:!0}},{get:(e,t)=>e=>({sym:J,startValue:e,tag:t})});function $(e){return{sym:C,startValue:e}}function z(...e){return{sym:D,mix:e}}function K(e){return{sym:q,startValue:e}}function R(e){return{sym:G,startValue:e}}function Q(e,t){return{sym:W,startValue:t,wrapper:e}}const X=e=>null!=e,Y=["constructor"];const Z=e=>"string"==typeof e,ee=(e,t)=>new Proxy({valence:e,core:t},{get:(s,n)=>s.core.nucleons[n]||function(e,t,s){let n=s.nucleons[e];if(!n&&!Y.includes(e)&&"string"==typeof e){const i=s.name?`${s.name}.${e}`:e;let r,a;if(a=s.saved,s.nucleons[e]=n=V(),t){let s=t[e];if(delete t[e],X(s)){const e=e=>{switch(e?.sym){case J:n.addMeta("tag",e.tag);break;case C:a=!0;break;case q:n.stateless();break;case G:n.finite();break;case W:n.setWrapper(e.wrapper)}X(e.startValue)&&(r=e.startValue)};switch(!0){case s.mix?.length>1:s.mix.forEach(t=>{switch(!0){case"function"==typeof t:e(t());break;case"symbol"==typeof t.sym:e(t);break;default:r=t}});break;case"symbol"==typeof s.sym:e(s);break;default:r=s}}}switch(s.nucleusStrategy){case"finite":n.finite();break;case"holistic":n.holistic();break;case"stateless":n.stateless();break;case"holystate":n.holistic(),n.stateless()}if(n.setId(i),a?(H.init(n),n.isEmpty&&X(r)&&n(r)):X(r)&&n(r),s.metaMap){const t=s.metaMap[e];t?.forEach(n.addMeta)}n.hasMeta("no_bus")||(s.emitChanges&&n.up(t=>{s.quarkBus.dispatchEvent("NUCLEUS_CHANGE",{key:e,value:t,atomId:s.name,n:n})}),s.quarkBus.dispatchEvent("NUCLEUS_INIT",n))}return n}(n,e,t)}),te=(e,t)=>new Proxy({getter:e,core:t},{get(e,t){const s=e.getter(t);return s?s.value:e.core[t]},set:(e,t,s)=>(e.core[t]=s,!0)}),se=(e,t)=>new Proxy({shell:e,core:t},{get(e,t){const s=e.shell[t];return null!=s?s:e.core[t]},set:(e,t,s)=>(e.core[t]=s,!0)}),ne=e=>new Proxy({atom:e},{get(e,t){if(Z(t))return e.atom[t].value},set:(e,t,s)=>!!Z(t)&&(e.atom[t](s),!0)});class ie{getNucleon;getters={};actions={};instaValues={};savedKeys=[];core;state;constructor(e,t){this.getNucleon=e,this.core=new Proxy({},{get(s,n,i){let r=t.nucleons[n];return r||(r=t.actions[n],r||e(n))}})}addEternals(e){this.savedKeys.push(...e)}}function re(e){const t={nucleons:{},actions:{},sleepingNucleons:{},superEternal:!1},s={values(){const e={};return s.keys?.forEach(t=>{e[t]=i.state[t]}),e}},n=new Set,i=new ie(function(e){let s=t.sleepingNucleons[e];if(s){s.getMeta("sleep")(),s.deleteMeta("sleep"),t.nucleons[e]=s,delete t.sleepingNucleons[e]}else s=t.nucleons[e]||c.atom[e];n||(n[e]=!0);return s},t);"saved"===e.nucleusStrategy||"*"===e.saved?t.superEternal=!0:"string"!=typeof e.saved&&e.saved&&"string"==typeof e.saved[0]&&(i.savedKeys=e.saved);const r=(t,n)=>{const r=function(e,t){const s={},n={},i={};if("function"==typeof e){const r=new e(t.constructorArgs),a=e=>{const t=Object.getOwnPropertyNames(e);if(-1===t.indexOf("__proto__")){t.forEach(t=>{if("constructor"===t)return;const i=Object.getOwnPropertyDescriptor(e,t);i.get?s[t]=i.get:n[t]=r[t]});const i=Object.getPrototypeOf(e);i&&a(i)}};a(e.prototype),Object.keys(r).forEach(e=>{i[e]=r[e]})}else Object.keys(e).forEach(t=>{const s=e[t];"function"==typeof s?n[t]=s:i[t]=s});return{getters:s,actions:n,saveds:[],instaValues:i}}(t,e);Object.assign(i.actions,r.actions),Object.assign(i.getters,r.getters),Object.assign(i.instaValues,r.instaValues),i.addEternals(r.saveds);const a=e=>!e.startsWith("_");s.actions=new Set(Object.keys(i.actions).filter(a));const o=Object.keys(r.instaValues);o.push(...Object.keys(r.getters)),s.keys=new Set(o.filter(a)),n&&i.addEternals(o)};e.model&&r(e.model),e.saved&&r(e.saved,!0);const a=!!e.bus,o=e.bus||new Proxy({id:u},P);var u;const c=function(e,t,s,n){const i=ee(e.instaValues,Object.assign({nucleons:{},quarkBus:n},s)),r=T(e,s.name);Object.assign(t.sleepingNucleons,r);const a=ne(i),o=te(e.getNucleon,a),u=se(t.actions,o),c=s.thisExtension?se(s.thisExtension,u):u;return e.state=c,Object.keys(e.actions).forEach(s=>{t.actions[s]=(...t)=>e.actions[s].apply(c,t)}),{atom:i}}(i,t,e,o);const l={core:i.core,state:i.state,actions:t.actions,decay:function(){Object.keys(n).forEach(e=>{let s=t.sleepingNucleons[e]||t.nucleons[e]||c.atom[e];s&&s.decay()}),a&&o.decay();y(l),y(c),y(s)},bus:o,known:s};return l}const ae=(e,t)=>ue({model:t,name:e,saved:!0}),oe=e=>new Proxy(ue({model:e}),{get:(e,t)=>e.core[t]}),ue=re,ce=re;class le{id}export{ce as A,ue as Atom,le as MultiAtomic,oe as coreAtom,R as finite,G as finiteSym,z as mixed,D as mixedSym,$ as saved,ae as savedAtom,C as savedSym,K as stateless,q as statelessSym,H as storage,U as tag,J as tagSym,Q as wrap,W as wrapSym};
