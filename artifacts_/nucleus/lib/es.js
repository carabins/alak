const t="await",e="clear",s="value",n="decay";function i(t,e,...s){t.stateListeners&&t.stateListeners.has(e)&&t.stateListeners.get(e).forEach(t=>t.apply(t,s))}function r(t,e,s){if(t.stateListeners||(t.stateListeners=new Map),t.stateListeners.has(e))t.stateListeners.get(e).add(s);else{const n=new Set;n.add(s),t.stateListeners.set(e,n)}}function a(t,e,s){if(t.stateListeners&&t.stateListeners.has(e)){const n=t.stateListeners.get(e);n.has(s)&&n.delete(s)}}function h(t,e){t.stateListeners&&t.stateListeners.forEach(t=>{t.has(e)&&t.delete(e)})}const u=t=>null!=t,o=t=>!!t,l=t=>e=>u(e)?null:t(e),c=t=>e=>u(e)?t(e):null,d=t=>e=>o(e)?t(e):null,f=t=>e=>u(e)&&!o(e)?t(e):null,p=t=>e=>o(e)?null:t(e),g=t=>e=>(s,n)=>{e(s,(e=>()=>e.down(t))(n))};function v(t){return!!t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof t.then}function _(t,e){return e&&e.then?y(t,e):(e=>{if(t.wrapperFn){const s=t.wrapperFn(e,t.value);if(s&&s.then)return y(t,s);e=s}if(!t.isFinite||t.value!=e)return t.prev=t.value,t.value=e,L(t),t.isStateless&&delete t.value,delete t.prev,e})(e)}async function y(e,s){i(e,t,!0),e.isAwaiting=s,e.isAsync=!0;const n=await s;if(!e.isFinite||e.value!=n)return e.prev=e.value,e.value=n,e.isAwaiting=!1,i(e,t,!1),L(e),e.isStateless&&delete e.value,delete e.prev,n}function L(t){const e=t.value,s=t.isHoly?t=>t(...e):s=>2==s.length?s(e,t._):s(e);t.listeners.size>0&&t.listeners.forEach(s),t.grandListeners&&t.grandListeners.size>0&&t.grandListeners.forEach(s)}function m(t,e,s){t.grandListeners||(t.grandListeners=new Map);const n=s(e.bind(t._));t.grandListeners.set(e,n),!t._.isEmpty&&n(t.value)}const w=(...t)=>{const e=function(...t){if(t.length){const s=e.isHoly?t:t[0];return _(e,s)}return e.isStateless?void L(e):e.isAwaiting?e.isAwaiting:e.getterFn?_(e,e.getterFn()):e.value};return e.listeners=new Set,e.uid=1e15*(Math.ceil(9*Math.random())+Math.random()),t.length&&e(...t),e};const E="value",b={isEmpty(){return!this.hasOwnProperty(E)},isFilled(){return this.hasOwnProperty(E)},haveListeners(){return this.listeners.size>0},[Symbol.toPrimitive](){return this._.toString()}},M=(t,e)=>!!t.hasOwnProperty(E)&&(t.isHoly?e.call(e,...t.value):e(t.value,t),!0),F={up(t){return this.listeners.add(t),M(this._,t),this._},down(t){return this.listeners.has(t)?this.listeners.delete(t):this.grandListeners&&this.grandListeners.has(t)&&this.grandListeners.delete(t),this._},silent(t){return this.value=t,this._},curry(){const t=this;return function(e){_(t,e)}},decay(t){var s;!t&&i(this,e,n),this.listeners.clear(),this.grandListeners&&this.grandListeners.clear(),this.stateListeners&&this.stateListeners.clear(),this.haveFrom&&delete this.haveFrom,delete this.value,this.risen&&this.risen.forEach(t=>t()),s=this,Object.keys(s).forEach(t=>{s[t]&&(s[t]=null),delete s[t]})},clearValue(){return i(this,e,s),delete this.value,this._},resend(){return L(this),this._},mutate(t){return this.value=t(this.value),L(this),this._},next(t){return this.listeners.add(t),this._},once(t){if(!M(this._,t)){const e=s=>{this.listeners.delete(e),t(s)};this.listeners.add(e)}return this._},is(t){return this._.isEmpty?void 0===t:this.value===t},parentFor(t,e){let s=t.getMeta("parents");s||(s={},t.addMeta("parents",s));const n=1|e,i=s[n];i&&i.down(t),s[n]=this._,this._.up(t)},onClear(t){r(this,e,t)},offClear(t){a(this,e,t)},onAwait(e){r(this,t,e)},offAwait(e){a(this,t,e)},upDown(t){return m(this,t,g(t)),this._},upSome(t){return m(this,t,c),this._},upTrue(t){return m(this,t,d),this._},upFalse(t){return m(this,t,p),this._},upSomeFalse(t){return m(this,t,f),this._},upNone(t){return m(this,t,l),this._},setId(t){return this.id=t,this._},setName(t){return this._name=t,Object.defineProperty(this,"name",{value:t}),this._},finite(t){return this.isFinite=null==t||t,this._},holistic(t){return this.isHoly=null==t||t,this._},stateless(t){return this.isStateless=null==t||t,this.isStateless&&this._.clearValue(),this._},bind(t){this._context!=t&&(this._context=t,this.bind(t))},apply(t,e){this.bind(t),_(this,e[0])},call(t,...e){this._(...e)},addMeta(t,e){return this.metaMap||(this.metaMap=new Map),this.metaMap.set(t,e||null),this._},deleteMeta(t){return!!this.metaMap&&this.metaMap.delete(t)},hasMeta(t){return!!this.metaMap&&this.metaMap.has(t)},getMeta(t){return this.metaMap?this.metaMap.get(t):null},dispatch(t,...e){return i(this,t,...e),this._},on(t,e){return r(this,t,e),this._},off(t,e){return a(this,t,e),this._},setGetter(t,e){return this.getterFn=t,this.isAsync=e,this._},setOnceGet(t,e){return this.getterFn=()=>(delete this.getterFn,delete this.isAsync,t()),this.isAsync=e,this._},setWrapper(t,e){return this.wrapperFn=t,this.isAsync=e,this._},tuneTo(t){this.tuneOff(),this.tunedTarget=t,t.up(this._)},tuneOff(){this.tunedTarget&&this.tunedTarget.down(this.tunedTarget)},injectTo(t,e){if(e||(e=this._name?this._name:this.id?this.id:this.uid),!t)throw"trying inject quark to null object";return t[e]=this.value,this._},cloneValue(){return JSON.parse(JSON.stringify(this.value))},[Symbol.toPrimitive](){this._.toString()},[Symbol.dispose](){this._.decay()},toString(){return`nucleon:${this._.uid}`},valueOf(){return`nucleon:${this._.uid}`},from:function(...t){const e=this;if(e.parents)throw"from nucleons already has a assigned";e.parents=t;const s=[],n=()=>new Promise(t=>s.push(t)),i=t=>{for(;s.length;)s.pop()(t);e.isAwaiting&&delete e.isAwaiting},r=s=>{const r=[],{strong:a,some:h}=s,o=a||h,l=t.map(t=>((t.isAwaiting||o&&!u(t.value))&&r.push(t),t.value));return r.length>0?(e.getterFn=n,e.isAwaiting=n()):(e.getterFn=()=>s(...l),v(c=s(...l))?c.then(t=>{i(t),_(e,t)}):(i(c),_(e,c)),e.isAwaiting&&delete e.isAwaiting,c);var c},a={},h=(t,s)=>{t.next(s),e.decayHooks||(e.decayHooks=[]),e.decayHooks.push(()=>t.down(s))};function o(s,n){function i(t,e){t!==a[e.uid]&&(r(s),a[e.uid]=t)}return t.forEach(t=>{t!==e._&&(a[t.uid]=t.value,h(t,i))}),r(s),e._}function l(s,r){let u={},o=!1;function l(r){const h={},c=()=>Object.keys(h).length,d=t.map(t=>{let e=u[t.uid];if(e)return e;const s=a[t.uid];return e=r&&r==t.uid?s||t():t.isStateless?t():s||t(),v(e)&&(h[t.uid]=!0,e.then(e=>{if(u[t.uid]=e,a[t.uid]=e,delete h[t.uid],!c()){const t=l();v(t)||i(t)}})),a[t.uid]=e,e});if(c())return e.getterFn=n,e.isAwaiting=n();e.getterFn=l,u={};const f=s(...d);return o||(o=!0,e(f)),f}e._.finite(r);const c={};function d(s,n){if(s!==a[n.uid]){if(a[n.uid]=s,!function(){let e=!1;const s=Object.keys(a);return s.forEach(t=>{a[t]!==c[t]&&(e=!0),c[t]=a[t]}),e&&t.length==s.length}())return;if(o){const t=l(n.uid);v(t)?t.then(e):e(t)}}}return t.forEach(t=>{t.uid!==e._.uid&&h(t,d)}),e.getterFn=()=>l(),l(),e._}return{some:function(t){return t.some=!0,o(t)},weak:t=>o(t),strong:t=>l(t,!0)}}},S={extensions:{}};function A(...t){t.forEach(t=>{Object.assign(S.extensions,t)})}const O={get(t,e){const s=t[e];if(s||void 0!==s||null!=s)return s;let n=S.extensions[e]||b[e];return n?n.apply(t):(n=F[e],n?(...e)=>n.call(t,...e):s)}};function j(t){const e=w(...arguments);return e._=new Proxy(e,O),e._}function x(t,e){t.everythingListeners?.has(e)&&t.everythingListeners.delete(e)}function T(t,e){t.everythingListeners||(t.everythingListeners=new Set),t.everythingListeners.add(e)}const P={decay(t){const e=t=>{t&&t.forEach(t.delete)};e(t.buses),e(t.everythingListeners),t.stateListeners&&t.stateListeners.forEach((e,s)=>t.stateListeners.delete(s))},addEverythingListener:T,addEventListener:(t,e,s)=>r(t,e,s),removeEventListener:(t,e,s)=>{a(t,e,s)},removeListener:(t,e)=>{h(t,e),x(t,e)},dispatchEvent:(t,e,s)=>{t.everythingListeners&&t.everythingListeners.forEach(t=>t(e,s)),i(t,e,s)},getListenersMap:t=>(t.stateListeners||(t.stateListeners=new Map),t.stateListeners),addEventToBus(t,e,s){const n=t=>s.dispatchEvent(e,t);return r(t,e,n),n},removeEventToBus(t,e){h(t,e)},addBus(t,e){t.buses||(t.buses=new Set),t.buses.has(e)||(t.buses.add(e),T(t,e.dispatchEvent))},removeBus(t,e){t.buses?.has(e)&&(t.buses.delete(e),x(t,e.dispatchEvent))}},k={get(t,e){const s=P[e];return s?(...e)=>s(t,...e):(console.error(e,"404",t),t[e])}};function H(t){return new Proxy({id:t},k)}const G=H,N=A,B=Object.assign(j,{setOnceGet:t=>j().setOnceGet(t),setGetter:t=>j().setGetter(t),setWrapper:t=>j().setWrapper(t),from:(...t)=>j().from(...t),stateless:()=>j().stateless(),holistic:()=>j().holistic(),id(t,e){const s=j().setId(t);return u(e)&&s(e),s}}),z=globalThis.Nucleus=B;export{B as N,z as Nucleus,G as Q,H as QuarkEventBus,B as default,N as installNucleonExtensions,A as nucleonExtensions};
