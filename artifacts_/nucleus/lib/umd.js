!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).nucleus={})}(this,function(e){"use strict";const t="await",s="clear",n="value",i="decay";function r(e,t,...s){e.stateListeners&&e.stateListeners.has(t)&&e.stateListeners.get(t).forEach(e=>e.apply(e,s))}function a(e,t,s){if(e.stateListeners||(e.stateListeners=new Map),e.stateListeners.has(t))e.stateListeners.get(t).add(s);else{const n=new Set;n.add(s),e.stateListeners.set(t,n)}}function u(e,t,s){if(e.stateListeners&&e.stateListeners.has(t)){const n=e.stateListeners.get(t);n.has(s)&&n.delete(s)}}function h(e,t){e.stateListeners&&e.stateListeners.forEach(e=>{e.has(t)&&e.delete(t)})}const o=e=>null!=e,l=e=>!!e,c=e=>t=>o(t)?null:e(t),d=e=>t=>o(t)?e(t):null,f=e=>t=>l(t)?e(t):null,p=e=>t=>o(t)&&!l(t)?e(t):null,g=e=>t=>l(t)?null:e(t),v=e=>t=>(s,n)=>{t(s,(t=>()=>t.down(e))(n))};function _(e){return!!e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof e.then}function y(e,t){return t&&t.then?L(e,t):(t=>{if(e.wrapperFn){const s=e.wrapperFn(t,e.value);if(s&&s.then)return L(e,s);t=s}if(!e.isFinite||e.value!=t)return e.prev=e.value,e.value=t,m(e),e.isStateless&&delete e.value,delete e.prev,t})(t)}async function L(e,s){r(e,t,!0),e.isAwaiting=s,e.isAsync=!0;const n=await s;if(!e.isFinite||e.value!=n)return e.prev=e.value,e.value=n,e.isAwaiting=!1,r(e,t,!1),m(e),e.isStateless&&delete e.value,delete e.prev,n}function m(e){const t=e.value,s=e.isHoly?e=>e(...t):s=>2==s.length?s(t,e._):s(t);e.listeners.size>0&&e.listeners.forEach(s),e.grandListeners&&e.grandListeners.size>0&&e.grandListeners.forEach(s)}function w(e,t,s){e.grandListeners||(e.grandListeners=new Map);const n=s(t.bind(e._));e.grandListeners.set(t,n),!e._.isEmpty&&n(e.value)}const E=(...e)=>{const t=function(...e){if(e.length){const s=t.isHoly?e:e[0];return y(t,s)}return t.isStateless?void m(t):t.isAwaiting?t.isAwaiting:t.getterFn?y(t,t.getterFn()):t.value};return t.listeners=new Set,t.uid=1e15*(Math.ceil(9*Math.random())+Math.random()),e.length&&t(...e),t};const b="value",M={isEmpty(){return!this.hasOwnProperty(b)},isFilled(){return this.hasOwnProperty(b)},haveListeners(){return this.listeners.size>0},[Symbol.toPrimitive](){return this._.toString()}},F=(e,t)=>!!e.hasOwnProperty(b)&&(e.isHoly?t.call(t,...e.value):t(e.value,e),!0),S={up(e){return this.listeners.add(e),F(this._,e),this._},down(e){return this.listeners.has(e)?this.listeners.delete(e):this.grandListeners&&this.grandListeners.has(e)&&this.grandListeners.delete(e),this._},silent(e){return this.value=e,this._},curry(){const e=this;return function(t){y(e,t)}},decay(e){var t;!e&&r(this,s,i),this.listeners.clear(),this.grandListeners&&this.grandListeners.clear(),this.stateListeners&&this.stateListeners.clear(),this.haveFrom&&delete this.haveFrom,delete this.value,this.risen&&this.risen.forEach(e=>e()),t=this,Object.keys(t).forEach(e=>{t[e]&&(t[e]=null),delete t[e]})},clearValue(){return r(this,s,n),delete this.value,this._},resend(){return m(this),this._},mutate(e){return this.value=e(this.value),m(this),this._},next(e){return this.listeners.add(e),this._},once(e){if(!F(this._,e)){const t=s=>{this.listeners.delete(t),e(s)};this.listeners.add(t)}return this._},is(e){return this._.isEmpty?void 0===e:this.value===e},parentFor(e,t){let s=e.getMeta("parents");s||(s={},e.addMeta("parents",s));const n=1|t,i=s[n];i&&i.down(e),s[n]=this._,this._.up(e)},onClear(e){a(this,s,e)},offClear(e){u(this,s,e)},onAwait(e){a(this,t,e)},offAwait(e){u(this,t,e)},upDown(e){return w(this,e,v(e)),this._},upSome(e){return w(this,e,d),this._},upTrue(e){return w(this,e,f),this._},upFalse(e){return w(this,e,g),this._},upSomeFalse(e){return w(this,e,p),this._},upNone(e){return w(this,e,c),this._},setId(e){return this.id=e,this._},setName(e){return this._name=e,Object.defineProperty(this,"name",{value:e}),this._},finite(e){return this.isFinite=null==e||e,this._},holistic(e){return this.isHoly=null==e||e,this._},stateless(e){return this.isStateless=null==e||e,this.isStateless&&this._.clearValue(),this._},bind(e){this._context!=e&&(this._context=e,this.bind(e))},apply(e,t){this.bind(e),y(this,t[0])},call(e,...t){this._(...t)},addMeta(e,t){return this.metaMap||(this.metaMap=new Map),this.metaMap.set(e,t||null),this._},deleteMeta(e){return!!this.metaMap&&this.metaMap.delete(e)},hasMeta(e){return!!this.metaMap&&this.metaMap.has(e)},getMeta(e){return this.metaMap?this.metaMap.get(e):null},dispatch(e,...t){return r(this,e,...t),this._},on(e,t){return a(this,e,t),this._},off(e,t){return u(this,e,t),this._},setGetter(e,t){return this.getterFn=e,this.isAsync=t,this._},setOnceGet(e,t){return this.getterFn=()=>(delete this.getterFn,delete this.isAsync,e()),this.isAsync=t,this._},setWrapper(e,t){return this.wrapperFn=e,this.isAsync=t,this._},tuneTo(e){this.tuneOff(),this.tunedTarget=e,e.up(this._)},tuneOff(){this.tunedTarget&&this.tunedTarget.down(this.tunedTarget)},injectTo(e,t){if(t||(t=this._name?this._name:this.id?this.id:this.uid),!e)throw"trying inject quark to null object";return e[t]=this.value,this._},cloneValue(){return JSON.parse(JSON.stringify(this.value))},[Symbol.toPrimitive](){this._.toString()},[Symbol.dispose](){this._.decay()},toString(){return`nucleon:${this._.uid}`},valueOf(){return`nucleon:${this._.uid}`},from:function(...e){const t=this;if(t.parents)throw"from nucleons already has a assigned";t.parents=e;const s=[],n=()=>new Promise(e=>s.push(e)),i=e=>{for(;s.length;)s.pop()(e);t.isAwaiting&&delete t.isAwaiting},r=s=>{const r=[],{strong:a,some:u}=s,h=a||u,l=e.map(e=>((e.isAwaiting||h&&!o(e.value))&&r.push(e),e.value));return r.length>0?(t.getterFn=n,t.isAwaiting=n()):(t.getterFn=()=>s(...l),_(c=s(...l))?c.then(e=>{i(e),y(t,e)}):(i(c),y(t,c)),t.isAwaiting&&delete t.isAwaiting,c);var c},a={},u=(e,s)=>{e.next(s),t.decayHooks||(t.decayHooks=[]),t.decayHooks.push(()=>e.down(s))};function h(s,n){function i(e,t){e!==a[t.uid]&&(r(s),a[t.uid]=e)}return e.forEach(e=>{e!==t._&&(a[e.uid]=e.value,u(e,i))}),r(s),t._}function l(s,r){let h={},o=!1;function l(r){const u={},c=()=>Object.keys(u).length,d=e.map(e=>{let t=h[e.uid];if(t)return t;const s=a[e.uid];return t=r&&r==e.uid?s||e():e.isStateless?e():s||e(),_(t)&&(u[e.uid]=!0,t.then(t=>{if(h[e.uid]=t,a[e.uid]=t,delete u[e.uid],!c()){const e=l();_(e)||i(e)}})),a[e.uid]=t,t});if(c())return t.getterFn=n,t.isAwaiting=n();t.getterFn=l,h={};const f=s(...d);return o||(o=!0,t(f)),f}t._.finite(r);const c={};function d(s,n){if(s!==a[n.uid]){if(a[n.uid]=s,!function(){let t=!1;const s=Object.keys(a);return s.forEach(e=>{a[e]!==c[e]&&(t=!0),c[e]=a[e]}),t&&e.length==s.length}())return;if(o){const e=l(n.uid);_(e)?e.then(t):t(e)}}}return e.forEach(e=>{e.uid!==t._.uid&&u(e,d)}),t.getterFn=()=>l(),l(),t._}return{some:function(e){return e.some=!0,h(e)},weak:e=>h(e),strong:e=>l(e,!0)}}},A={extensions:{}};function O(...e){e.forEach(e=>{Object.assign(A.extensions,e)})}const x={get(e,t){const s=e[t];if(s||void 0!==s||null!=s)return s;let n=A.extensions[t]||M[t];return n?n.apply(e):(n=S[t],n?(...t)=>n.call(e,...t):s)}};function j(e){const t=E(...arguments);return t._=new Proxy(t,x),t._}function T(e,t){e.everythingListeners?.has(t)&&e.everythingListeners.delete(t)}function P(e,t){e.everythingListeners||(e.everythingListeners=new Set),e.everythingListeners.add(t)}const k={decay(e){const t=e=>{e&&e.forEach(e.delete)};t(e.buses),t(e.everythingListeners),e.stateListeners&&e.stateListeners.forEach((t,s)=>e.stateListeners.delete(s))},addEverythingListener:P,addEventListener:(e,t,s)=>a(e,t,s),removeEventListener:(e,t,s)=>{u(e,t,s)},removeListener:(e,t)=>{h(e,t),T(e,t)},dispatchEvent:(e,t,s)=>{e.everythingListeners&&e.everythingListeners.forEach(e=>e(t,s)),r(e,t,s)},getListenersMap:e=>(e.stateListeners||(e.stateListeners=new Map),e.stateListeners),addEventToBus(e,t,s){const n=e=>s.dispatchEvent(t,e);return a(e,t,n),n},removeEventToBus(e,t){h(e,t)},addBus(e,t){e.buses||(e.buses=new Set),e.buses.has(t)||(e.buses.add(t),P(e,t.dispatchEvent))},removeBus(e,t){e.buses?.has(t)&&(e.buses.delete(t),T(e,t.dispatchEvent))}},N={get(e,t){const s=k[t];return s?(...t)=>s(e,...t):(console.error(t,"404",e),e[t])}};function H(e){return new Proxy({id:e},N)}const G=H,B=O,z=Object.assign(j,{setOnceGet:e=>j().setOnceGet(e),setGetter:e=>j().setGetter(e),setWrapper:e=>j().setWrapper(e),from:(...e)=>j().from(...e),stateless:()=>j().stateless(),holistic:()=>j().holistic(),id(e,t){const s=j().setId(e);return o(t)&&s(t),s}}),V=globalThis.Nucleus=z;e.N=z,e.Nucleus=V,e.Q=G,e.QuarkEventBus=H,e.default=z,e.installNucleonExtensions=B,e.nucleonExtensions=O,Object.defineProperty(e,"__esModule",{value:!0})});
