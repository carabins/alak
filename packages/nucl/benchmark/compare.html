<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nucl vs Quark - Browser Benchmark</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      color: #60a5fa;
      margin-bottom: 10px;
      font-size: 32px;
      text-align: center;
    }

    .subtitle {
      color: #9ca3af;
      margin-bottom: 30px;
      font-size: 14px;
      text-align: center;
    }

    .controls {
      text-align: center;
      margin-bottom: 30px;
    }

    .btn {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(96, 165, 250, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(96, 165, 250, 0.4);
    }

    .btn:disabled {
      background: #4b5563;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .summary {
      background: linear-gradient(135deg, #2a2a3e 0%, #1f2937 100%);
      border: 2px solid #60a5fa;
      padding: 30px;
      margin-bottom: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(96, 165, 250, 0.1);
    }

    .summary h2 {
      color: #60a5fa;
      margin-bottom: 20px;
      font-size: 26px;
      text-align: center;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 25px;
    }

    .stat-box {
      background: rgba(96, 165, 250, 0.08);
      padding: 20px;
      border-radius: 10px;
      border-left: 5px solid;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .stat-box.quark {
      border-left-color: #9ca3af;
    }

    .stat-box.nucl {
      border-left-color: #60a5fa;
    }

    .stat-box.nucl-plugins {
      border-left-color: #8b5cf6;
    }

    .stat-box.heavy {
      border-left-color: #10b981;
    }

    .stat-label {
      color: #9ca3af;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-box.quark .stat-value {
      color: #9ca3af;
    }

    .stat-box.nucl .stat-value {
      color: #60a5fa;
    }

    .stat-box.nucl-plugins .stat-value {
      color: #8b5cf6;
    }

    .stat-box.heavy .stat-value {
      color: #10b981;
    }

    .stat-delta {
      font-size: 14px;
      font-weight: 600;
    }

    .stat-delta.positive {
      color: #10b981;
    }

    .stat-delta.negative {
      color: #ef4444;
    }

    .benchmark-item {
      background: rgba(31, 41, 55, 0.6);
      border: 1px solid #374151;
      margin-bottom: 20px;
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .benchmark-item:hover {
      border-color: #60a5fa;
      box-shadow: 0 4px 20px rgba(96, 165, 250, 0.15);
    }

    .benchmark-header {
      background: rgba(96, 165, 250, 0.1);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #374151;
    }

    .benchmark-name {
      font-size: 18px;
      font-weight: 600;
      color: #60a5fa;
    }

    .benchmark-status {
      font-size: 14px;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
    }

    .benchmark-status.pending {
      background: rgba(156, 163, 175, 0.2);
      color: #9ca3af;
    }

    .benchmark-status.running {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      animation: pulse 2s ease-in-out infinite;
    }

    .benchmark-status.complete {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .benchmark-body {
      padding: 20px;
    }

    .comparison-bars {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .bar-row {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .bar-label {
      width: 120px;
      font-size: 14px;
      font-weight: 600;
      text-align: right;
    }

    .bar-label.quark { color: #9ca3af; }
    .bar-label.nucl { color: #60a5fa; }
    .bar-label.nucl-plugins { color: #8b5cf6; }
    .bar-label.heavy { color: #10b981; }

    .bar-container {
      flex: 1;
      height: 35px;
      background: rgba(55, 65, 81, 0.5);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      height: 100%;
      border-radius: 8px;
      transition: width 1s ease-out;
      display: flex;
      align-items: center;
      padding: 0 15px;
      font-weight: 600;
      font-size: 13px;
      position: relative;
    }

    .bar-fill.quark {
      background: linear-gradient(90deg, #6b7280 0%, #4b5563 100%);
    }

    .bar-fill.nucl {
      background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 100%);
    }

    .bar-fill.nucl-plugins {
      background: linear-gradient(90deg, #8b5cf6 0%, #7c3aed 100%);
    }

    .bar-fill.heavy {
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
    }

    .bar-value {
      color: white;
      font-weight: 700;
      white-space: nowrap;
    }

    .bar-delta {
      position: absolute;
      right: 15px;
      font-size: 12px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.3);
    }

    .progress-section {
      background: rgba(31, 41, 55, 0.6);
      border: 1px solid #374151;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(55, 65, 81, 0.5);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 100%);
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      color: #9ca3af;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚ö° Nucl vs Quark - Browser Benchmark</h1>
    <p class="subtitle">Real-time performance comparison in your browser</p>

    <div class="controls">
      <button class="btn" id="runBtn" onclick="runBenchmarks()">Run Benchmarks</button>
    </div>

    <div class="progress-section" id="progressSection" style="display: none;">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">Starting...</div>
    </div>

    <div class="summary" id="summary" style="display: none;">
      <h2>üìä Summary</h2>
      <div class="stats-grid">
        <div class="stat-box quark">
          <div class="stat-label">Quark (baseline)</div>
          <div class="stat-value" id="avgQuark">-</div>
          <div class="stat-delta">ops/ms</div>
        </div>
        <div class="stat-box nucl">
          <div class="stat-label">Nucl (bare)</div>
          <div class="stat-value" id="avgNucl">-</div>
          <div class="stat-delta" id="deltaNucl">-</div>
        </div>
        <div class="stat-box nucl-plugins">
          <div class="stat-label">Nucl+plugins</div>
          <div class="stat-value" id="avgPlugins">-</div>
          <div class="stat-delta" id="deltaPlugins">-</div>
        </div>
        <div class="stat-box heavy">
          <div class="stat-label">HeavyNucl</div>
          <div class="stat-value" id="avgHeavy">-</div>
          <div class="stat-delta" id="deltaHeavy">-</div>
        </div>
      </div>
    </div>

    <div id="results"></div>
  </div>

  <script type="module">
    // Import libraries
    import { Qu } from './dist/quark.js'
    import { Nucl } from './dist/nucl.js'
    import { Nucl as NuclWithPlugins } from './dist/nucl-plugins.js'
    import { HeavyNucl } from './dist/heavy.js'

    // Make available globally
    window.Qu = Qu
    window.Nucl = Nucl
    window.NuclWithPlugins = NuclWithPlugins
    window.HeavyNucl = HeavyNucl
  </script>

  <script>
    const tests = [
      { name: 'Create empty', ops: 100000, fn: (Factory) => { const q = Factory() } },
      { name: 'Create with value', ops: 100000, fn: (Factory) => { const q = Factory(42) } },
      { name: 'Get value', ops: 500000, fn: (Factory) => { const q = Factory(42); const v = q.value } },
      { name: 'Set value', ops: 300000, fn: (Factory) => { const q = Factory(0); q(42) } },
      { name: 'Add listener', ops: 50000, fn: (Factory) => { const q = Factory(0); q.up(() => {}) } },
      { name: 'Notify 1 listener', ops: 50000, fn: (Factory) => { const q = Factory(0); let c = 0; q.up(() => c++); q(1) } },
      { name: 'Notify 5 listeners', ops: 30000, fn: (Factory) => { const q = Factory(0); let c = 0; q.up(() => c++); q.up(() => c++); q.up(() => c++); q.up(() => c++); q.up(() => c++); q(1) } }
    ]

    function bench(name, ops, fn) {
      // Warm-up
      for (let i = 0; i < 1000; i++) fn()

      // Actual test
      const start = performance.now()
      for (let i = 0; i < ops; i++) fn()
      const time = performance.now() - start

      return {
        name,
        ops,
        time: Math.round(time * 100) / 100,
        opsPerMs: Math.round((ops / time) * 100) / 100
      }
    }

    function formatNumber(num) {
      return num.toLocaleString('en-US', { maximumFractionDigits: 2 })
    }

    function createBenchmarkItem(test, index) {
      const item = document.createElement('div')
      item.className = 'benchmark-item'
      item.innerHTML = `
        <div class="benchmark-header">
          <div class="benchmark-name">${test.name}</div>
          <div class="benchmark-status pending" id="status-${index}">Pending</div>
        </div>
        <div class="benchmark-body">
          <div class="comparison-bars" id="bars-${index}">
            <div class="bar-row">
              <div class="bar-label quark">Quark</div>
              <div class="bar-container">
                <div class="bar-fill quark" id="bar-quark-${index}" style="width: 0%">
                  <span class="bar-value" id="val-quark-${index}"></span>
                </div>
              </div>
            </div>
            <div class="bar-row">
              <div class="bar-label nucl">Nucl</div>
              <div class="bar-container">
                <div class="bar-fill nucl" id="bar-nucl-${index}" style="width: 0%">
                  <span class="bar-value" id="val-nucl-${index}"></span>
                  <span class="bar-delta" id="delta-nucl-${index}"></span>
                </div>
              </div>
            </div>
            <div class="bar-row">
              <div class="bar-label nucl-plugins">Nucl+plugins</div>
              <div class="bar-container">
                <div class="bar-fill nucl-plugins" id="bar-plugins-${index}" style="width: 0%">
                  <span class="bar-value" id="val-plugins-${index}"></span>
                  <span class="bar-delta" id="delta-plugins-${index}"></span>
                </div>
              </div>
            </div>
            <div class="bar-row">
              <div class="bar-label heavy">HeavyNucl</div>
              <div class="bar-container">
                <div class="bar-fill heavy" id="bar-heavy-${index}" style="width: 0%">
                  <span class="bar-value" id="val-heavy-${index}"></span>
                  <span class="bar-delta" id="delta-heavy-${index}"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `
      return item
    }

    async function runBenchmarks() {
      const runBtn = document.getElementById('runBtn')
      const progressSection = document.getElementById('progressSection')
      const progressFill = document.getElementById('progressFill')
      const progressText = document.getElementById('progressText')
      const results = document.getElementById('results')
      const summary = document.getElementById('summary')

      runBtn.disabled = true
      progressSection.style.display = 'block'
      results.innerHTML = ''
      summary.style.display = 'none'

      // Create benchmark items
      tests.forEach((test, i) => {
        results.appendChild(createBenchmarkItem(test, i))
      })

      const allResults = []

      for (let i = 0; i < tests.length; i++) {
        const test = tests[i]
        const progress = ((i + 1) / tests.length) * 100

        progressFill.style.width = progress + '%'
        progressText.textContent = `Running: ${test.name} (${i + 1}/${tests.length})`

        const statusEl = document.getElementById(`status-${i}`)
        statusEl.textContent = 'Running...'
        statusEl.className = 'benchmark-status running'

        // Run tests sequentially with delay
        await new Promise(resolve => setTimeout(resolve, 100))

        const quarkResult = bench(test.name, test.ops, () => test.fn(window.Qu))
        await new Promise(resolve => setTimeout(resolve, 50))

        const nuclResult = bench(test.name, test.ops, () => test.fn(window.Nucl))
        await new Promise(resolve => setTimeout(resolve, 50))

        const pluginsResult = bench(test.name, test.ops, () => test.fn(window.NuclWithPlugins))
        await new Promise(resolve => setTimeout(resolve, 50))

        const heavyResult = bench(test.name, test.ops, () => test.fn(window.HeavyNucl))
        await new Promise(resolve => setTimeout(resolve, 50))

        allResults.push({
          quark: quarkResult,
          nucl: nuclResult,
          plugins: pluginsResult,
          heavy: heavyResult
        })

        // Update UI
        const maxOps = Math.max(quarkResult.opsPerMs, nuclResult.opsPerMs, pluginsResult.opsPerMs, heavyResult.opsPerMs)
        const quarkPercent = (quarkResult.opsPerMs / maxOps) * 100
        const nuclPercent = (nuclResult.opsPerMs / maxOps) * 100
        const pluginsPercent = (pluginsResult.opsPerMs / maxOps) * 100
        const heavyPercent = (heavyResult.opsPerMs / maxOps) * 100

        document.getElementById(`bar-quark-${i}`).style.width = quarkPercent + '%'
        document.getElementById(`bar-nucl-${i}`).style.width = nuclPercent + '%'
        document.getElementById(`bar-plugins-${i}`).style.width = pluginsPercent + '%'
        document.getElementById(`bar-heavy-${i}`).style.width = heavyPercent + '%'

        document.getElementById(`val-quark-${i}`).textContent = formatNumber(quarkResult.opsPerMs) + ' ops/ms'
        document.getElementById(`val-nucl-${i}`).textContent = formatNumber(nuclResult.opsPerMs) + ' ops/ms'
        document.getElementById(`val-plugins-${i}`).textContent = formatNumber(pluginsResult.opsPerMs) + ' ops/ms'
        document.getElementById(`val-heavy-${i}`).textContent = formatNumber(heavyResult.opsPerMs) + ' ops/ms'

        function setDelta(id, value, baseline) {
          const delta = ((value - baseline) / baseline * 100).toFixed(1)
          const el = document.getElementById(id)
          el.textContent = (delta > 0 ? '+' : '') + delta + '%'
          el.style.color = delta > 0 ? '#10b981' : '#ef4444'
        }

        setDelta(`delta-nucl-${i}`, nuclResult.opsPerMs, quarkResult.opsPerMs)
        setDelta(`delta-plugins-${i}`, pluginsResult.opsPerMs, quarkResult.opsPerMs)
        setDelta(`delta-heavy-${i}`, heavyResult.opsPerMs, quarkResult.opsPerMs)

        statusEl.textContent = 'Complete'
        statusEl.className = 'benchmark-status complete'
      }

      // Show summary
      const avgQuark = allResults.reduce((sum, r) => sum + r.quark.opsPerMs, 0) / allResults.length
      const avgNucl = allResults.reduce((sum, r) => sum + r.nucl.opsPerMs, 0) / allResults.length
      const avgPlugins = allResults.reduce((sum, r) => sum + r.plugins.opsPerMs, 0) / allResults.length
      const avgHeavy = allResults.reduce((sum, r) => sum + r.heavy.opsPerMs, 0) / allResults.length

      document.getElementById('avgQuark').textContent = formatNumber(avgQuark)
      document.getElementById('avgNucl').textContent = formatNumber(avgNucl)
      document.getElementById('avgPlugins').textContent = formatNumber(avgPlugins)
      document.getElementById('avgHeavy').textContent = formatNumber(avgHeavy)

      function setSummaryDelta(id, value, baseline) {
        const delta = ((value - baseline) / baseline * 100).toFixed(2)
        const el = document.getElementById(id)
        el.textContent = (delta > 0 ? '+' : '') + delta + '%'
        el.className = 'stat-delta ' + (delta > 0 ? 'positive' : 'negative')
      }

      setSummaryDelta('deltaNucl', avgNucl, avgQuark)
      setSummaryDelta('deltaPlugins', avgPlugins, avgQuark)
      setSummaryDelta('deltaHeavy', avgHeavy, avgQuark)

      summary.style.display = 'block'
      progressSection.style.display = 'none'
      runBtn.disabled = false

      // Save results to server
      const dataToSave = {
        timestamp: Date.now(),
        userAgent: navigator.userAgent,
        results: allResults.map(r => ({
          name: r.quark.name.replace(' (Quark)', ''),
          quark: { opsPerMs: r.quark.opsPerMs },
          nucl: { opsPerMs: r.nucl.opsPerMs },
          plugins: { opsPerMs: r.plugins.opsPerMs },
          heavy: { opsPerMs: r.heavy.opsPerMs }
        })),
        summary: {
          avgQuark,
          avgNucl,
          avgPlugins,
          avgHeavy,
          nuclDelta: ((avgNucl - avgQuark) / avgQuark * 100).toFixed(2),
          pluginsDelta: ((avgPlugins - avgQuark) / avgQuark * 100).toFixed(2),
          heavyDelta: ((avgHeavy - avgQuark) / avgQuark * 100).toFixed(2)
        }
      }

      try {
        const response = await fetch('/save-results', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dataToSave)
        })
        const result = await response.json()
        console.log('‚úÖ Results saved to server:', result)
      } catch (error) {
        console.error('‚ùå Failed to save results:', error)
      }
    }
  </script>
</body>
</html>
