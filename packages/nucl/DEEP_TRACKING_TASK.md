# Задача: Реализовать глубокое отслеживание как встроенную опциональную функциональность в Nucl

## Контекст задачи

Сейчас в Nucl реализованы два разных подхода к глубокому отслеживанию:
1. Через флаг `DEEP_TRACKING` и функцию `createDeepTrackingProxy`
2. Через отдельный плагин `deep-watch` с функциями `getDeep`, `setDeep`, `watchDeep`

Требуется объединить функциональность и сделать глубокое отслеживание опциональной встроенной функциональностью, а не плагином.

## Проблемы, требующие решения

### 1. Дублирующаяся функциональность
- Имеются два разных механизма для глубокого отслеживания
- Это ведет к избыточному коду и возможным конфликтам

### 2. Падающие тесты
Последние запуски тестов показали следующие падения:
- `✗ deep watch plugin - basic functionality`
- `✗ deep watch plugin - array operations`
- `✗ deep watch plugin - nested object changes`
- `✗ Fusion auto-cleanup on source decay`

### 3. Неправильное отслеживание изменений
- Текущая реализация `watchDeep` срабатывает при любом изменении вложенной структуры, а не только при изменении конкретного свойства
- Это приводит к лишним срабатываниям наблюдателей при обновлении других свойств

### 4. Проблема с авт очисткой фьюзии
- При распаде источника фьюзия не полностью очищается и сохраняет старое значение
- Требуется улучшить логику автоматической очистки при распаде источника

## Требуемые изменения

### 1. Объединение глубокого отслеживания
- Интегрировать функции `getDeep`, `setDeep`, `watchDeep` в основной Nucl API
- Сделать глубокое отслеживание опциональной встроенной функциональностью через опцию `deepTracking: true`
- Убрать зависимость от плагина `deep-watch` для базовой функциональности

### 2. Исправление функции `watchDeep`
- Реализовать точное отслеживание изменений по конкретным путям
- Убедиться, что наблюдатель срабатывает только при изменении конкретного свойства
- Избежать лишних срабатываний при изменении других свойств

### 3. Исправление авт очистки фьюзии
- Обеспечить полную очистку фьюзии при распаде любого источника
- Убедиться, что значение фьюзии становится `undefined` после распада источника
- Проверить, что все подписки корректно удаляются

### 4. Оптимизация производительности
- Обеспечить эффективное кэширование Proxy-объектов
- Оптимизировать функции `getDeep`, `setDeep`, `watchDeep` для работы с большими и глубокими структурами
- Улучшить алгоритмы обхода путей и обновления значений

## Техническая реализация

### 1. Обновленная реализация `watchDeep`
- Создать систему подписок, которая отслеживает изменения только по конкретным путям
- Использовать нормализованные пути для эффективного сравнения
- Реализовать проверку, действительно ли значение изменилось, перед вызовом коллбэка

### 2. Обновленная реализация `createDeepTrackingProxy`
- Добавить уведомление системы глубокого отслеживания о конкретных изменениях
- Реализовать точную систему отслеживания изменений по конкретным путям
- Обеспечить интеграцию между Proxy и системой наблюдения

### 3. Обновленная реализация `fusion`
- Улучшить логику очистки при распаде источника
- Обеспечить переопределение метода `decay` для фьюзии
- Убедиться, что при распаде любого источника фьюзия также полностью очищается

### 4. Интеграция в основной Nucl API
- Добавить методы `getDeep`, `setDeep`, `watchDeep` в прототип Nucl при включении опции `deepTracking`
- Обеспечить корректную работу этих методов с Proxy-объектами
- Поддерживать обратную совместимость

## Ожидаемые результаты

### 1. Прохождение тестов
- Все тесты должны проходить успешно:
  - `deep watch plugin - basic functionality`
  - `deep watch plugin - array operations`
  - `deep watch plugin - nested object changes`
  - `Fusion auto-cleanup on source decay`

### 2. Улучшенная архитектура
- Устранение дублирующейся функциональности
- Глубокое отслеживание как встроенная опциональная функция, а не плагин
- Более эффективная и согласованная система отслеживания

### 3. Лучшая производительность
- Оптимизированные алгоритмы для работы с глубокими структурами
- Эффективное кэширование и обход путей
- Минимальные накладные расходы при отключенном глубоком отслеживании

## Проверка реализации

### 1. Запуск тестов
```bash
bun test
```

### 2. Проверка производительности
- Сравнение производительности до и после изменений
- Проверка, что накладные расходы минимальны при отключенном глубоком отслеживании

### 3. Ручное тестирование
- Проверка работы всех функций: `getDeep`, `setDeep`, `watchDeep`
- Проверка корректного поведения фьюзии при распаде источников
- Проверка работы с различными типами данных (объекты, массивы, вложенные структуры)